<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../fat-chat-shared-styles/fat-chat-shared-styles.html"/>
<link rel="import" href="../behaviors/fat-behavior.html">

<dom-module id="fat-chat-client">
    <template>
        <style include="shared-styles"/>
        <style>
            :host {
                display: block;
            }
        </style>

        <div class="content">
            <template is="dom-repeat" items="[[users]]" as="user">
                <div class="user">
                    <paper-material>
                        <div class="container" tabindex="0">
                            <img src="[[user.image]]" style="width:36px;height:36px;border-radius:50%;">
                            <span>[[user.name]]</span>
                            <paper-button raised noink on-tap="initiateChat">Chat</paper-button>
                        </div>
                    </paper-material>
                </div>
            </template>
        </div>

        <firebase-query
            app-name="fat-data"
            id="query"
            path="/users2"
            data="{{users}}">
        </firebase-query>

        <firebase-document
            app-name="fat-data"
            id="conversations"
            path="/users2/[[userId]]/conversations"
            data="{{conversationData}}"
            log="true">
        </firebase-document>

    </template>

    <script>

        Polymer({
            is: 'fat-chat-client',
            behaviours: [FAT],
            properties: {
                userId: {
                    type: String,
                    notify: true
                },
                userName: {
                    type: String,
                    notify: true
                },
                conversationData: {
                    type: Object,
                    notify: true,
                    observer: '_conversationDataChange'                    
                },
            },
            initiateChat: function (e) {
                var recipientId = e.model.user.$key;
                var recipientName = e.model.user.name;
                var recipientImage = e.model.user.image;
                this._createConversation(recipientId, recipientName, recipientImage);
            },
            _createConversation: function(recipientId, recipientName, recipientImage) {
                
                var conversations = this.conversationData.hasOwnProperty("conversations") 
                    ? this.conversationData.conversations
                    : {};
                    
                var conversation = conversations.hasOwnProperty(recipientId)
                    ? conversations[recipientId]
                    : {};
                    
                if (!conversation.hasOwnProperty("members")) {
                    conversation.name = recipientName;
                    conversation.image = recipientImage;
                    var d = new Date();
                    var n = d.getTime(); 
                    conversation.timestamp = n;
                    
                    conversation.messages = {};
                    conversation.members = {};
                    conversation.members[this.userId] = this._createMember(this.userName);
                    conversation.members[recipientId] = this._createMember(recipientName);
                    conversations[recipientId] = conversation;
                }
                
                FAT.updateValue(this.$.conversations, this.$.conversations.path, conversations);
            },            
            _createMember: function(memberName) {
                return {
                    name: memberName
                }
            },
            _conversationDataChange: function() {
                console.log("User id = " + this.userId);
                console.log(this.$.conversations.path);
                console.log(this.conversationData);
            }            
        });
    </script>
</dom-module>
