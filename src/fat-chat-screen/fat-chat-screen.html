<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../fat-chat-shared-styles/fat-chat-shared-styles.html"/>

<dom-module id="fat-chat-screen">
    <template>
        <style include="shared-styles"/>
        <style>
            :host {
                display: block;
            }
        </style>
        
        <firebase-document
                app-name="fat-data"
                path="/users2/[[userId]]/conversations/[[cid]]"
                data="{{conversation}}">
        </firebase-document>

        <div class="content">
            <span>[[conversation.name]]</span>
            <template is="dom-repeat" items="[[conversation.messages]]" as="message" sort="_sortByTime">
                <div class="message">
                    <paper-material>
                        <div class="container" tabindex="0">
                            <span class="width:100%;">[[message.message]]<br><br>sender : [[message.sender]]<br>time : [[message.time]]</span>
                        </div>
                    </paper-material>
                </div>
            </template>
            <div class="message">
                <paper-material>
                    <div class="container" tabindex="0">
                        <span><input user="[[userId]]" onchange="createMessage(this.value, this.user);this.value='';"/></span>
                    </div>
                </paper-material> 
            </div>
       </div>

    </template>

    <script>

        Polymer({
            is: 'fat-chat-screen',
            properties: {
                cid: String
            },
            logger: function (obj) {
                console.log(obj);
            },
            _sortByTime: function(a, b) {
                return b.time - a.time;
            }
        });

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
            }

            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                    s4() + '-' + s4() + s4() + s4();
        }

        function createMessage(message, userId) {
            var msg = {};
            msg.message = message;
            msg.sender = userId;
            msg.time = Date.now();
            var timestamp = Date.now();
            
            document.querySelector('#query2').setStoredValue(document.querySelector('#query2').path + '/' + guid(), msg);
            this.set('conversation.timestamp', timestamp);
        }

    </script>
</dom-module>
